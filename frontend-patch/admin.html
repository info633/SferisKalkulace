<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin — Pricebook (MVP)</title>
  <link rel="stylesheet" href="styles.css">
  <script type="module" src="auth.js"></script>
  <style>
    .wrap { max-width: 1100px; margin: 20px auto; background:#fff; border-radius: 12px; padding: 1rem; border:1px solid #ddd; }
    input, select, textarea { padding:.55rem .7rem; margin:.25rem; }
    table { width:100%; border-collapse: collapse; margin-top:.6rem; }
    th, td { border:1px solid #ddd; padding:.45rem .6rem; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:1rem; }
  </style>
</head>
<body>
  <header class="header">
    <h1>SFERIS – Admin (MVP)</h1>
    <p id="userEmail"></p>
  </header>

  <main class="wrap">
    <section>
      <h3>Pricebooky</h3>
      <button id="btnNewPB" class="btn-primary">Vytvořit nový</button>
      <div id="pbs"></div>
    </section>

    <section class="grid">
      <div>
        <h3>Položky</h3>
        <div>
          <input id="item-code" placeholder="code">
          <input id="item-label" placeholder="label">
          <select id="item-category">
            <option value="material">material</option>
            <option value="work">work</option>
          </select>
          <input id="item-unit" placeholder="unit" value="m2">
          <input id="item-norm" placeholder="norm" value="1" type="number" step="0.01">
          <input id="item-price" placeholder="basePriceCZK" type="number" step="1">
          <button id="btnAddItem" class="btn-primary">Přidat položku</button>
        </div>
        <table id="itemsTbl"><thead><tr><th>code</th><th>label</th><th>cat</th><th>unit</th><th>norm</th><th>price</th></tr></thead><tbody></tbody></table>
      </div>

      <div>
        <h3>Skladby</h3>
        <div>
          <input id="comp-module" placeholder="module" value="fasada">
          <input id="comp-variant" placeholder="variant" value="eps">
          <textarea id="comp-lines" placeholder='lines JSON např. [{"code":"mat.eps200","qtyPerUnit":1}]' rows="3"></textarea>
          <button id="btnAddComp" class="btn-primary">Přidat skladbu</button>
        </div>
        <table id="compsTbl"><thead><tr><th>module</th><th>variant</th><th>lines</th></tr></thead><tbody></tbody></table>
      </div>
    </section>
  </main>

  <script type="module">
    import { auth } from './auth.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js';
    const API_BASE = window.SFERIS_API_BASE || 'http://localhost:8080';

    let currentPB = null;

    onAuthStateChanged(auth, async user => {
      if (!user || !user.email.endsWith('@sferis.cz')) {
        alert('Jen @sferis.cz');
        window.location.href = 'login.html';
        return;
      }
      document.getElementById('userEmail').textContent = `Přihlášen: ${user.email}`;
      await loadPBs();
    });

    async function token(){ return auth.currentUser.getIdToken(); }

    async function loadPBs(){
      const res = await fetch(`${API_BASE}/v1/pricebooks`, { headers: { 'Authorization': `Bearer ${await token()}` } });
      const data = await res.json();
      const box = document.getElementById('pbs'); box.innerHTML = '';
      (data.items || []).forEach(pb => {
        const b = document.createElement('button');
        b.textContent = `${pb.name} [${pb.status}]`;
        b.className = 'btn-primary';
        b.style.marginRight = '.4rem';
        b.onclick = () => selectPB(pb.id);
        box.appendChild(b);
      });
    }

    async function selectPB(id){
      currentPB = id;
      await loadItems();
      await loadComps();
    }

    async function loadItems(){
      const res = await fetch(`${API_BASE}/v1/pricebooks/${currentPB}/items`, { headers: { 'Authorization': `Bearer ${await token()}` } });
      const data = await res.json();
      const tbody = document.querySelector('#itemsTbl tbody'); tbody.innerHTML='';
      (data.items || []).forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.code}</td><td>${r.label}</td><td>${r.category}</td><td>${r.unit}</td><td>${r.norm}</td><td>${r.basePriceCZK}</td>`;
        tbody.appendChild(tr);
      });
    }

    async function loadComps(){
      const res = await fetch(`${API_BASE}/v1/pricebooks/${currentPB}/compositions`, { headers: { 'Authorization': `Bearer ${await token()}` } });
      const data = await res.json();
      const tbody = document.querySelector('#compsTbl tbody'); tbody.innerHTML='';
      (data.compositions || []).forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.module}</td><td>${r.variant}</td><td><pre>${JSON.stringify(r.lines)}</pre></td>`;
        tbody.appendChild(tr);
      });
    }

    document.getElementById('btnNewPB').onclick = async () => {
      const name = prompt('Název pricebooku:', 'Default');
      if (!name) return;
      const res = await fetch(`${API_BASE}/v1/pricebooks`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${await token()}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, status: 'published', effectiveFrom: new Date().toISOString() })
      });
      if (res.ok) await loadPBs(); else alert('Chyba vytvoření PB');
    };

    document.getElementById('btnAddItem').onclick = async () => {
      if (!currentPB) { alert('Vyberte pricebook'); return; }
      const row = {
        code: document.getElementById('item-code').value,
        label: document.getElementById('item-label').value,
        category: document.getElementById('item-category').value,
        unit: document.getElementById('item-unit').value,
        norm: parseFloat(document.getElementById('item-norm').value || '1'),
        basePriceCZK: parseFloat(document.getElementById('item-price').value || '0'),
        vat: 12
      };
      const res = await fetch(`${API_BASE}/v1/pricebooks/${currentPB}/items`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${await token()}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: [row] })
      });
      if (res.ok) await loadItems(); else alert('Chyba přidání položky');
    };

    document.getElementById('btnAddComp').onclick = async () => {
      if (!currentPB) { alert('Vyberte pricebook'); return; }
      const row = {
        module: document.getElementById('comp-module').value,
        variant: document.getElementById('comp-variant').value,
        lines: JSON.parse(document.getElementById('comp-lines').value || '[]')
      };
      const res = await fetch(`${API_BASE}/v1/pricebooks/${currentPB}/compositions`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${await token()}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ compositions: [row] })
      });
      if (res.ok) await loadComps(); else alert('Chyba přidání skladby');
    };
  </script>
</body>
</html>
